<style type="text/css">
	.tasklist {
		padding: 0;
	}

	.tab-con {
		margin-left: 15px;
	}

	.tab-con .SetupPostfix {
		overflow: hidden;
	}

	.tab-con .clearfixPostfix>p {
		float: left;
		margin-top: 35px;
		margin-left: 25px;
	}

	.tab-con .clearfixPostfix>p button {
		margin-right: 15px;
		padding-left: 18px;
		padding-right: 18px;
	}

	.tab-con .SetupPostfix .clearfixPostfix {
		overflow: hidden;
		margin-bottom: 25px;
	}

	.tab-con .SetupPostfix .SetAggregateOne p {
		margin-top: 15px;
	}

	.tab-con .SetupPostfix .SetAggregateOne p span {
		margin-right: 15px;
		display: inline-block;
		width: 51px;
		text-align: right;
	}

	.tab-con .SetupPostfix .SetAggregateOne p input {
		height: 30px;
		width: 240px;
		padding-left: 10px;
		font-size: 13px;
	}

	.tab-con .SetupPostfix .SetAggregateOne {
		width: 325px;
		float: left;
	}

	.tasklist .tab-nav {
		background-color: #F0F0F1;
		width: 125px;
		height: 650px;
		float: left;
		border-bottom: 0px;
	}

	.tasklist .tab-nav span {
		display: block;
		width: 125px;
		padding-right: 0;
		height: 40px;
		line-height: 40px;
		padding-left: 20px;
		position: relative;
		cursor: pointer;
		border: none;
		background: #F0F0F1;
	}
	.send_mail_conter {
		padding: 20px 10px;
	}
	.send_mail_conter input {
		width: 95%;
		border-radius: 0;
		box-shadow: 1px 1px 2px #ececec inset;
		outline: 0;
		padding: 0 10px;
	}
	.domain_table {
		height: 450px;
	}
	.tasklist .tab-nav span.on {
		background-color: #fff;
	}

	.send_mail_conter .line {
		margin-bottom: 10px;
	}

	.send_mail_conter .line>span {
		width: 60px;
		height: 30px;
		line-height: 30px;
		margin-right: 10px;
		text-align: right;
		display: inline-block;
	}

	.send_mail_conter .line .conter {
		width: 90%;
		height: 30px;
		line-height: 30px;
		display: inline-block;

	}

	.send_mail_conter .sender_list {
		margin-left: -3px;
		padding: 0 10px;
	}

	.editor_conter {
		position: relative;
		height: 290px;
	}

	.editor_conter .sname {
		position: absolute;
		top: 0px;
	}
	.cke_editor_editor1{
		width: 95%;
	}

	.editor_conter .conter {
		position: absolute;
		left:73px;
		height: 100% !important;
	}

	.right {
		width: auto;
		height: auto;
		position: initial;
	}

	.radio_glign_ground {
		display: inline-block;
		height: 25px;
		line-height: 25px;
		vertical-align: top;
		margin-right: 15px;
		font-weight: 400;
		font-size: 14px;
	}

	.radio_glign {
		height: 15px;
		width: 15px;
		position: relative;
		top: 2px;
		margin-right: 5px !important;
	}

	.bt-form-login .line .tname {
		width: 110px;
	}

	#domain_list .btswitch+.btswitch-btn,
	#mailboxs_list .btswitch+.btswitch-btn {
		width: 2.4em;
		height: 1.4em;
		margin-bottom: 0
	}

	#Editor .w-e-toolbar,
	#Editor .w-e-text-container {
		width: 95%
	}

	.service_tip {
		display: inline-block;
		width: 100%;
		height: 35px;
		line-height: 35px;
		background: #F0F0F1;
		padding-right: 15px;
		text-align: right;
	}

	.mail_title {
		width: 100%;
		background: #ecf5ff;
		border-bottom: 1px solid #ececec;
		padding: 20px 45px;
	}

	.mail_title ul li {
		height: 20px;
		line-height: 20px;
		margin-bottom: 5px;
      	color:#888;
	}

	.mail_title ul h4 {
      	color:#333;
		font-size: 16px;
		font-weight: 600;
		padding-bottom: 5px;
      	padding-bottom: 5px;
      	border-bottom:1px solid #ececec;
	}

	.mail_conter {
		line-height: 25px;
		font-size: 13px;
		padding: 35px 45px;
	}

	.cke_editor_editor1 .cke_top {
		padding: 2px;
		height: 28px !important;
	}

	.mail_html {
		display: inline-block;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		vertical-align: bottom;
	}
	.mail_html span{
		color: #bbb;
	}

	input[readonly] {
		background-color: #efefef;
	}
	.selects_conter{
		position: relative;
		z-index: 999
	}
	.selects_conter .select_text{
		display: inline-block;
		height: 36px;
		line-height: 36px;
		padding:0 15px;
		position: relative;
		border: 1px solid #ececec;
		background: #f3f3f3;
		color: #666;
	}
	.select_conter{
		display: inline-block;
		/* padding: 7px 15px; */
		padding-right: 35px;
		font-size: 14px;
		border: 1px solid #ececec;
		color: #444;
		position: relative;
		cursor: pointer;
		height: 36px;
		line-height: 36px;
		margin-left: -5px;
		vertical-align: bottom;
	}
	.select_conter .domain_input{
		display: inline-block;
		padding-left: 15px;
		height: 34px;
	}
	.select_conter .select_down{
		display: inline-block;
		width: 0;
		height: 0;
		border-width: 6px;
		border-style: solid;
		border-color:#777 transparent transparent transparent;
		position: absolute;
		top: 14px;
		right: 12px;
		transition: all 500ms;
	}

	.select_conter .domain_list{
		display: none;
		background: #fff;
		position: absolute;
		top: 34px;
		left: -1px;
		border: 1px solid #ececec;
	}
	.select_conter .domain_list.active{
		display: block;
	}
	.select_conter .domain_list li{
		text-align: left;
		padding: 0 15px;
	}
	.select_conter .domain_list li:hover{
		background: #20a53a;
		color: #fff;
	}
	.select_conter .domain_list li.active{
		background: #20a53a;
		color: #fff;
	}

	.bt_tips {
		font-size: 16px;
		color: #444;
		font-weight: 600;
		margin-bottom: 10px;
	}
	.bt_vice_tips{
		font-size: 14px;
		color: #666;
		margin-bottom: 10px;
	}
	.bt-body .bt_conter{
		margin-bottom: 30px;
	}
	.bt-body .bt_center{
		text-align: center;
		margin-bottom: 15px;
	}
	.mail_table{
		height: 550px;
    	overflow: auto;
	}
	.bt_select{
		display: inline-block;
		width: auto;
		outline: none;
		border-radius: 0;
		height: 30px;
		line-height: 30px;
		padding: 0 10px;
		font-size: 13px;
	}
	.member_table{
		height: 350px;
	}
	.user_info .help-info-text b{
		/* font-size:  */
		color: #666;
	}
</style>
<div class="tasklist">
	<div class="tab-nav">
      	<span class="on">域名列表</span>
		<span>收件箱</span>
		<span>发送邮件</span>
	</div>
	<div class="tab-con">
      	<div class="task_block pd15">
			<button class="btn btn-sm btn-success mb15" style="margin-right:10px;" onclick="mail.edit_domain_view(true)">添加域名</button>
			<div class="domain_table divtable">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>邮箱域名</th>
							<th>MX记录</th>
							<th>TXT记录</th>
							<th width="130px" style="text-align: right;">操作</th>
						</tr>
					</thead>
					<tbody id="domain_list"></tbody>
				</table>
			</div>
			<ul class="help-info-text c7 mlr20">
				<li><font style="color:red">添加域名后，需要添加MX记录（用于邮箱服务）和TXT记录（用于邮箱反垃圾服务）才能正常使用邮箱服务。</font></li>
				<!-- <li><font style="color:red">不建议使用腾讯云和阿里云服务器自建邮局，由于腾讯云和阿里云服务器相关政策导致自建邮局SMTP服务（25端口被禁用，且不能用于发送邮件服务）无法发送邮件。</font></li> -->
				<li><font style="color:red">提示： 部分云厂商(如：阿里云，腾讯云)默认关闭25端口，需联系厂商开通25端口后才能正常使用邮局服务</font></li>
				<li>该自建邮局版本为基础版本，仅提供基础功能，更多功能请耐心等候开发进度。</li>
			</ul>
		</div>
		<div class="task_block" style="height: 630px;display:none;">
			<div class=" pd15">
				<div class="selects_conter" style="margin-bottom: 10px;">
					<span  class="select_text">邮件归属</span>
					<div class="select_conter">
						<span class="domain_input"></span>
						<ul class="domain_list" id="domain_select_list" style="overflow-y: auto;max-height: 280px;"></ul>
						<span class="select_down"></span>
					</div>
				</div>
				<div class="mail_table divtable">
					<table class="table table-hover">
						<thead>
							<tr>
								<th width="15%">发件人</th>
								<th>主题</th>
								<th width="200">时间</th>
								<th width="90">操作</th>
							</tr>
						</thead>
						<tbody id="mails_list"></tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="task_block send_mail_conter" style="display:none;">
			<div class="line" style="margin-bottom:0;">
				<span class="sname">发送人</span>
				<div class="conter sender_name">
					<select class="bt_select form-control"></select>
				</div>
			</div>
			<div class="line"><span class="sname">收件人</span>
				<div class="conter"><input type="text" name="mail_to" class="bt-input-text" placeholder="多个收件人请使用‘,’分隔收件人邮箱"></div>
			</div>
			<div class="line"><span class="sname">主题</span>
				<div class="conter"><input type="text" name="subject" class="bt-input-text"></div>
			</div>
			<div class="line editor_conter">
				<span class="sname">正文</span>
				<div class="conter">
					<textarea name="editor1" id="editor1" rows="10" cols="80"></textarea>
				</div>
			</div>
			<div class="line">
				<span class="sname">&nbsp;</span>
				<div class="conter"><button class="btn btn-sm btn-success" style="border-radius:0;" onclick="mail.sublimt_send_mail_request()">发送邮件</button></div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	var mail = {
		plugin_name: 'mail_sys',
		_editor: '',
		_domain_name: '',
		mail_list: '',
		domain_list: '',
		mailboxs_list: '',
		_server_hostname:'',
		is_update:true,
		// 初始化
		init: function () {
			var _this = this;
			$('.layui-layer-page').width('1000');

			$('.tasklist .tab-nav span').click(function(){
				var index = $(this).index();
				$(this).addClass('on').siblings().removeClass('on');
				$('.tab-con .task_block').eq(index).show().siblings().hide();
				switch (index) {
					case 0:
						_this.create_domain_list();
					break;
					case 1:
						_this.create_mail_list();
					break;
					case 2:
						if($('.bt_select').html() == ''){
							_this.get_domains_html();
						}

					break;
				}
			});

			$('#domain_list').on('click', '.open-switch-actives', function () {
				var checked = $(this).prop('checked');
				var index = $(this).attr('data-index');
				var _form = _this.domain_list[index];
				_this.update_domain({
					active: checked ? 1 : 0,
					domain: _form.domain,
					company_name: _form.company_name,
					admin_name: _form.admin_name,
					admin_phone: _form.admin_phone
				}, function (res) {
					layer.msg(res.msg, { icon: 1 });
				});
			});

			$('#domain_list').on('click', '.del_domain', function () {
				var domain = $(this).attr('data-domain');
				layer.confirm('是否删除【' + domain + '】域名', { icon: 0, closeBtn: 2, title: '删除域名' }, function (index) {
					_this.del_domain({
						domain: domain
					}, function (res) {
						_this.create_domain_list({ page: 1, size: 20 }, function () {
							layer.msg(res.msg, { icon: 1 });
						});
					});
				});
			});

			$('#domain_list').on('click', '.edit_ground_domain', function () {
				var domain = $(this).attr('data-domain');
				var index = $(this).attr('data-index');
				var hostname = $(this).attr('data-hostname');
				if(_this.domain_list[index].mx_status == 0 && _this.domain_list[index].mx_status == 0){
					layer.msg('当前域名未设置或暂未生效或记录多于一条',{icon:0})
					return false;
				}
				layer.open({
					type: 1,
					title: '[' + domain + ']_用户管理',
					area: ['900px', '620px'],
					closeBtn: 2,
					content: '<div class="pd15 user_info">\
								<button class="btn btn-sm btn-success mb15" style="margin-right:10px;" onclick="mail.edit_mailboxs_view(true)">添加用户</button>\
								<div class="member_table divtable">\
									<table class="table table-hover">\
										<thead><tr><th>邮箱</th><th>姓名</th><th>邮箱容量</th><th>类型</th><th>状态</th><th width="100px">操作</th></tr></thead>\
										<tbody id="mailboxs_list"></tbody>\
									</table>\
									<div class="page" id="mailboxs_page"></div>\
								</div>\
								<ul class="help-info-text c7 mlr20">\
									<li>注意事项:当前邮件服务仅支持POP3和IMAP方式，http接口调用&nbsp;<a href="javascript:;" class="btlink open_btlink_down">下载API文档</a>&nbsp;</li>\
									<li>POP服务【服务地址：<b>&nbsp;'+hostname +'&nbsp;</b>、端口：<b>&nbsp;110&nbsp;</b>】</li>\
									<li>IMAP服务【服务地址：<b>&nbsp;'+hostname+'&nbsp;</b>、端口：<b>&nbsp;143&nbsp;</b>】</li>\
									<li>SMTP服务【服务地址：<b>&nbsp;'+hostname+'&nbsp;</b>、端口：<b>&nbsp;25&nbsp;</b>】</li>\
									<li>以上邮件服务暂不支持SSL登录</li>\
								</ul>\
							</div>',
					success: function () {
						$('.open_btlink_down').click(function(){
							window.open('/download?filename='+encodeURIComponent('/www/server/panel/plugin/mail_sys/static/api.zip'));
						});

						_this.create_mailboxs_list({ domain: domain});
						$('#mailboxs_list').on('click', '.open-switch-active', function () {
							var checked = $(this).prop('checked');
							var index = $(this).attr('data-index');
							var _form = _this.mailboxs_list[index];
							_this.updatae_mailboxs({
								quota: _form.quota/1024/1024/1024,
								username: _form.username,
								password: _form.password,
								quote: _form.quote,
								full_name: _form.full_name,
								active: checked ? 1 : 0,
								is_admin: _form.is_admin
							}, function (res) {
								layer.msg(res.msg, { icon: 1 });
							});
						});
						$('#mailboxs_list').on('click', '.edit_mailboxs', function () {
							var _index = $(this).attr('data-index');
							var _form = _this.mailboxs_list[_index];
							_this.edit_mailboxs_view(false, _form);
						});
						$('#mailboxs_list').on('click', '.del_mailboxs', function () {
							var username = $(this).attr('data-username');
							layer.confirm('是否删除【' + username + '】成员', { icon: 0, closeBtn: 2, title: '删除成员' }, function (index) {
								_this.del_mailboxs({
									username: username
								}, function (res) {
									_this.create_mailboxs_list({ domain: domain}, function () {
										layer.msg(res.msg, { icon: 1 });
									});
								});
							});
						});
					},cancel:function(){
						_this.is_update = true;
					}
				});
			});

			$('.select_conter').click(function(e){
				var domain_list = $(this).find('.domain_list');
				if($(this).find('.domain_list').hasClass('active')){
					$(this).find('.domain_list').removeClass('active');
				}else{
					$(this).find('.domain_list').addClass('active');
				}
				var width = $(this).innerWidth();
				$('#domain_select_list').width(width);
				$('body').click(function(e){
					$('#domain_select_list').removeClass('active');
					$('body').unbind();
				});
				e.preventDefault();
				e.stopPropagation();
			});

			$('#domain_select_list').on('click','li',function(e){
				var val = $(this).text();
				$(this).addClass('active').siblings().removeClass('active').parent().removeClass('active');
				$('.domain_input').text(val);
				_this.create_mail_list();
				e.preventDefault();
				e.stopPropagation();
			});

			_this.check_mail_sys({tips:'正在检查邮局服务是否正常,请稍后....',hostname:''},function(res){
				if(res.status == false && res.msg == '之前没有安装过邮局系统，请放心安装!'){
					layer.open({
						type: 1,
						title: '邮局初始化',
						area: ['590px', '280px'],
						closeBtn: 2,
						btn: ['安装', '取消'],
						content:"<div class='bt-form pd20'>\
							<div class='line'>\
								<span class='tname' style='width: 130px;'>邮局服务器域名</span>\
								<div class='info-r c4'>\
									<input class='bt-input-text mr5' type='text' name='hostname' value='' placeholder='请输入邮局服务器域名，例如：btmail.if22.cn' style='width:330px;' />\
								</div>\
								<ul class='help-info-text c7 mlr20'>\
									<li>邮局服务器域名需要添加A记录至邮局服务器IP</li>\
									<li>添加A记录解析参数【记录类型：<span style='font-weight: 600;'>A</span>，主机记录：<span style='font-weight: 600;'>btmail</span>，记录值：<span style='font-weight: 600;'>邮局服务器IP地址</span>】</li>\
									<li><font style='color:red'>提示： 部分云厂商(如：阿里云，腾讯云)默认关闭25端口，需联系厂商开通25端口后才能正常使用邮局服务</li>\
								</ul>\
							</div>\
						</div>",
						yes:function(index,layers){
							var hostname = $('[name="hostname"]').val();
							if(hostname == ''){
								layer.msg('邮局服务器域名不能为空！',{icon:2});
								return false;
							}
							_this.setup_mail_sys({tips:'正在安装邮局服务，请稍后...',hostname:hostname},function(res){
                              layer.close(index)
                              layer.msg(res.msg,{icon:res.status?1:2});
                              _this.create_domain_list();
							});
						},
						btn2:function(){
							layer.closeAll();
						},
						cancel:function(){
							layer.closeAll();
						}
					})
				}else{
                  _this.create_domain_list();
				}
			});

			this.loadScript('/static/ckeditor/ckeditor.js',function(){ CKEDITOR.replace('editor1', { customConfig: '/static/ckeditor/config.js' })})
		},
		// 动态加载脚本
		loadScript:function(src, callback){
			var script = document.createElement('script'),
				head = document.getElementsByTagName('head')[0];
			script.type = 'text/javascript';
			script.charset = 'UTF-8';
			script.src = src;
			if (script.addEventListener) {
				script.addEventListener('load', function () {
				callback();
				}, false);
			} else if (script.attachEvent) {
				script.attachEvent('onreadystatechange', function () {
				var target = window.event.srcElement;
				if (target.readyState == 'loaded') {
					callback();
				}
				});
			}
			head.appendChild(script);
		},
		// 获取邮箱服务是否正常
		check_mail_sys:function(obj,callback){
			this.send({
				tips: obj.tips,
				method: 'check_mail_sys',
				data:{hostname:obj.hostname},
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})

		},
		// 获取邮箱
		setup_mail_sys:function(obj,callback){
			this.send({
				tips: obj.tips,
				method: 'setup_mail_sys',
				data:{hostname:obj.hostname},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 表格自动适应宽度
		table_auto_width:function(el,ratio){
			var width = $('.layui-layer-page').width();
			$('#mails_list '+el).width( parseInt(width * parseFloat(ratio)));
		},
		// 编辑邮箱用户视图
		edit_mailboxs_view: function (type, obj) {
			var _this = this;
			if (obj == undefined) {
				obj = {
					is_admin: 0,
					username: '',
					password: '',
					quota: 5368709120,
					full_name: '',
					department: '',
					position: '',
					phone: '',
					sex: 0
				}
			}
			layer.open({
				type: 1,
				title: type ? '添加用户' : '编辑用户',
				area: '450px',
				closeBtn: 2,
				btn: [type ? '提交' : '保存', '取消'],
				content: "<div class='bt-form pd20'>\
						<div class='line'>\
							<span class='tname'>用户类型</span>\
							<div class='info-r c4'>\
								<select name='is_admin' class='bt-input-text'>\
									<option value='0' "+ (obj.is_admin == 0 ? 'selected' : '') + ">普通用户</option>\
									<option value='1' "+ (obj.is_admin == 1 ? 'selected' : '') + ">管理员</option>\
								</select>\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>姓名</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='full_name' value='"+ obj.full_name + "' placeholder='请输入用户姓名' style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>邮箱地址</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='username' "+ (!type ? 'readonly' : '') + " placeholder='请输入邮箱地址' value='" + obj.username.split('@')[0] + "' placeholder='' style='width:180px' />@" + mail._domain_name + "\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>邮箱密码</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='password' value='"+ (obj.password || '') + "' placeholder='" + (!type ? "为空则不修改密码" : "请输入邮箱密码") + "' style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>邮箱容量</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='quota' value='"+ (obj.quota / 1024 / 1024 / 1024) + "' placeholder='请输入邮箱容量' style='width:250px;' />G\
							</div>\
						</div>\
					</div>",
				yes: function (index, layers) {
					var array = [['username', '邮箱地址不能为空!'], ['quota', '邮箱容量不能为空！'], ['full_name', '用户姓名不能为空！']], _form = {}, tel_reg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/,paw_reg = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).*$/
					for (var i = 0; i < array.length; i++) {
						if ($('[name="' + array[i][0] + '"]').val() == '') {
							layer.msg(array[i][1], { icon: 2 });
							return false;
						} else if (array[i][0] == 'phone' && !tel_reg.test($('[name="' + array[i][0] + '"]').val())) {
							layer.msg('成员手机号码格式错误，请重试！', { icon: 2 });
							return false;
						}
						_form[array[i][0]] = $('[name="' + array[i][0] + '"]').val();
					}
					_form['sex'] = $('[name="sex"]:checked').val();
					_form['is_admin'] = $('[name="is_admin"]').val();
					_form['password'] = $('[name="password"]').val();
					_form['username'] = $('[name="username"]').val() + '@' + mail._domain_name;
					if(type){
						if(_form['password'].length <8){
							layer.msg('当前邮箱用户密码长度小于8位,请重新输入',{icon:0});
							return false;
						}else if(!paw_reg.test(_form['password'])){
							layer.msg('当前邮箱用户密码至少要包含大小写字母和数字，请重新输入',{icon:0});
							return false;
						}
						_this.add_mailboxs(_form, function (res) {
							_this.create_mailboxs_list({ domain: _this._domain_name}, function () {
								layer.msg(res.msg, { icon: 1 });
								layer.close(index);
							});
						});
					} else {
						_form['active'] = obj.active;
						_this.updatae_mailboxs(_form, function (res) {
							_this.create_mailboxs_list({ domain: _this._domain_name}, function () {
								layer.msg(res.msg, { icon: 1 });
								layer.close(index);
							});
						});
					}
				}
			});
		},

		// 设置解析邮箱
		set_analysis_mail:function(domain,hostname){
			var _this = this;
			layer.open({
				type:1,
				title:'【'+ domain +'】添加记录值',
				area:'600px;',
				closeBtn:2,
				content:"<div class='bt-body divtable pd20'>\
					<div class='bt_tips'>第一步:添加MX记录</div>\
					<div class='bt_conter'>\
						<div class='bt_vice_tips'>登录域名服务商，添加记录类型为MX的记录，用于邮箱服务(请直接复制下列参数)</div>\
						<div class='bt_vice_conter'>\
							<table class='table table-hover'>\
								<thead><tr><th>记录类型</th><th>主机记录</th><th>记录值</th><th>MX优先级</th></tr></thead>\
								<tbody><tr><td>MX</td><td>@</td><td>"+ hostname +"&nbsp;<a href='javascript:;' class='btlink btn_copy' data-clipboard-text='"+ hostname +"'>( 复制 )</a>&nbsp;</td><td>10</td></tr></tbody>\
							</table>\
						</div>\
					</div>\
					<div class='bt_tips'>第二步:添加TXT记录</div>\
					<div class='bt_conter'>\
						<div class='bt_vice_tips'>添加记录类型为TXT的记录，用于邮箱反垃圾(请直接复制下列参数)</div>\
						<div class='bt_vice_conter'>\
							<table class='table table-hover'>\
								<thead><tr><th>记录类型</th><th>主机记录</th><th>记录值</th></tr></thead>\
								<tbody><tr><td>TXT</td><td>@</td><td>v=spf1 a mx ~all&nbsp;<a href='javascript:;' class='btlink btn_copy' data-clipboard-text='v=spf1 a mx ~all'>( 复制 )</a>&nbsp;</td></tr></tbody>\
							</table>\
						</div>\
					</div>\
					<div class='bt_center'><button class='btn btn-success btn-sm btn_set_analysis'>已设置，验证域名解析</button></div>\
				</div>",
				success:function(layers,index){
					var copyBtn = new ClipboardJS('.btn_copy');
					copyBtn.on("success",function(e){
						layer.msg('复制成功！',{icon:1})
						e.clearSelection();
					});
					copyBtn.on("error",function(e){
						layer.msg('复制失败，请手动复制文本！',{icon:2})
					});
					$('.btn_set_analysis').click(function(){
                      	_this.delete_mx_txt_cache({domain:domain},function(res){
							_this.create_domain_list();
							layer.close(index);
						});
					});
				}
			});
		},
		//删除max记录和txt记录
        delete_mx_txt_cache:function(obj,callback){
        	this.send({
				tips: '正在清除MAX记录和TXT记录缓存，请稍后...',
				method: 'delete_mx_txt_cache',
				data:{domain:obj.domain},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 编辑添加邮箱用户视图
		edit_domain_view: function (type, obj) {
			var _this = this;
			if (obj == undefined) {
				obj = {
					domain: '',
					company_name: '',
					admin_name: '',
					admin_phone: ''
				}
			}
			layer.open({
				type: 1,
				title: type ? '添加邮箱域名' : '编辑邮箱域名',
				area: '400px',
				closeBtn: 2,
				btn: [type ? '提交' : '保存', '取消'],
				content: "<div class='bt-form pd20'>\
					<div class='line'>\
						<span class='tname'>邮箱域名</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='domain'  "+ (!type ? "readonly='readonly'" : "") + "	 value='" + obj.domain + "' placeholder='请输入域名，例如btmail.cn' style='width:210px;' />\
						</div>\
					</div>\
					<div class='line'>\
						<ul class=’help-info-text c7 mlr20‘ style='padding-left: 55px;color: red;'>\
							<li>注意事项:&nbsp;&nbsp;当前邮箱域名仅支持一级域名</li>\
						</ul>\
					</div>\
				</div>",
				yes: function (index, layers) {
					var array = [['domain', '邮箱域名不能为空！']], _form = {}, tel_reg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
					for (var i = 0; i < array.length; i++) {
						if ($('[name="' + array[i][0] + '"]').val() == '') {
							layer.msg(array[i][1], { icon: 2 });
							return false;
						} else if (array[i][0] == 'admin_phone' && !tel_reg.test($('[name="' + array[i][0] + '"]').val())) {
							layer.msg('管理手机号码格式错误，请重试！', { icon: 2 });
							return false;
						}
						_form[array[i][0]] = $('[name="' + array[i][0] + '"]').val();
					}
					if (type) {
						_this.add_domain(_form, function (res) {
							_this.create_domain_list({ page: 1, size: 20 }, function (res) {
								var rdata = res.data, hostname = rdata;
								for(var i = 0;i<rdata.length;i++){
									if(rdata[i].domain == _form['domain']) hostname = rdata[i]['domain']
								}
								_this.set_analysis_mail(hostname,res.hostname);
								layer.close(index);
							});
						});
					} else {
						_form['active'] = obj.active;
						_this.update_domain(_form, function (res) {
							_this.create_domain_list({ page: 1, size: 20 }, function (res) {
								layer.msg(res.msg, { icon: 1 });
								layer.close(index);
							});
						});
					}
				}
			})
		},
		// 提交发送邮箱请求
		sublimt_send_mail_request: function (type) {
			var _this = this;
			var mail_to = $('[name="mail_to"]').val();
			mail_to = JSON.stringify(mail_to.split(','))
			var subject = $('[name="subject"]').val();
			var data = CKEDITOR.instances.editor1.getData();
			if (mail_to == '') {
				layer.msg('请输入收件人！', { icon: 0 });
				return false;
			} else if (subject == '') {
				layer.msg('请输入邮件主题！', { icon: 0 });
				return false;
			} else if (data == '') {
				layer.msg('请输入邮件内容！', { icon: 0 });
				return false;
			}
			this.send_mail_conter({
				mail_from: $('.bt_select').val(),
				mail_to: mail_to,
				subject: subject,
				content: data,
				subtype: 'html',
				smtp_server: 'localhost'
			}, function (res) {
				layer.msg(res.msg, { icon: 1 });
				$('[name="subject"]').val('')
				CKEDITOR.instances.editor1.setData('')
			})
		},
		// 创建邮件用户列表
		create_mailboxs_list: function (obj, callback) {
			var _this = this;
			this.is_update = true;
			this.get_mailboxs_list(obj, function (res) {
				var _tbody = '', rdata = res.data;
				_this.mailboxs_list = rdata
				_this._domain_name = obj.domain;
				if(rdata.length > 0){
                  for (var i = 0; i < rdata.length; i++) {
                      _tbody += '<tr><td>' + rdata[i].username + '</td><td>' + rdata[i].full_name + '</td><td>' + (rdata[i].quota / 1024 / 1024 / 1024) + 'G</td><td>' + (!rdata[i].is_admin ? '普通用户' : '管理员') + '</td><td><div class="index-item"><input class="btswitch btswitch-ios open-switch-active" id="is_active_' + i + '" type="checkbox" ' + (rdata[i].active == 1 ? "checked" : "") + ' data-index="' + i + '"><label class="btswitch-btn" for="is_active_' + i + '"></label></div></td><td><a href="javascript:;" class="btlink edit_mailboxs" data-index="' + i + '">编辑</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:;" class="btlink red del_mailboxs" data-username="' + rdata[i].username + '">删除</a></td></tr>';
                  };
                }
				$('#mailboxs_list').html(_tbody);
				$('#mailboxs_page').html(res.page);
				_this.create_domains_html(res);
				if (callback) callback(res);
			});
		},
		// 创建域名列表
		create_domain_list: function (obj, callback) {
			if (obj == undefined) obj = { page: 1, size: 15 }
			var _this = this;
			this.get_domain_list(obj, function (res) {
				var _tbody = '', rdata = res.data;
				_this.domain_list = rdata
              	if(rdata.length > 0){
                  for (var i = 0; i < rdata.length; i++) {
                      _tbody += '<tr>\
                          <td>' + rdata[i].domain + '</td>\
                          <td>' + (rdata[i].mx_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>已设置</div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].domain +'\',\''+ res.hostname +'\')">未设置记录值</a></div>') + '</td>\
                          <td>' + (rdata[i].txt_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>已设置</span></div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].domain +'\',\''+ res.hostname +'\')">未设置记录值</a></div>') + '</td>\
                          <td style="text-align: right;">'+(rdata[i].mx_status && rdata[i].txt_status?('<a href="javascript:;" class="btlink edit_ground_domain" data-hostname="'+ res.hostname +'" data-domain="' + rdata[i].domain + '" data-index="'+ i +'">用户管理</a>'):('<a href="javascript:;" class="btlink" onclick="mail.set_analysis_mail(\''+ rdata[i].domain +'\',\''+ res.hostname +'\')">添加记录值</a>')) +'&nbsp;&nbsp;|&nbsp;&nbsp;\
                              <a href="javascript:;" class="btlink red del_domain" data-domain="' + rdata[i].domain + '">删除</a>\
                          </td>\
                          </tr>';
                  };
                }
				$('#domain_list').html(_tbody);
				$('#mailboxs_page').html(res.page);
				if (callback) callback(res);
			});
		},

		get_domains_html:function(callback){
			var _this = this;
			_this.get_mailboxs_list({},function(res){
				_this.is_update?_this.create_domains_html(res):'';
				if(callback) callback(res);
			});
		},
		create_domains_html:function(res){
			var _tbody = '',_option,rdata = res.data;
			if(rdata.length == 0){
				$('.domain_input').html('暂无用户');
				$('#mails_list').html('<tr><td colspan="5"></td></tr>')
				return false;
			}
			for(var i=0;i<rdata.length;i++){
				_tbody +='<li '+ (i== 0?'class="active"':'') +'>'+ rdata[i].username +'</li>'
			}
			for(var j=0;j<rdata.length;j++){
				_option += '<option vlaue="'+ rdata[j].username +'">'+ rdata[j].username +'</option>'
			}
			$('.domain_input').html(rdata[0].username);
			$('#domain_select_list').html(_tbody);
			$('.bt_select').html(_option)
		},
		// 获取邮件列表
		get_mail_list: function (obj, callback) {
			var _this = this, _form = {};
			this.send({
				tips: '正在获取邮箱列表，请稍后...',
				method: 'get_mails',
				data: obj,
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		formatTime: function (val) {
          	val = Math.round(new Date(val) / 1000)
			var dateTime = new Date(parseInt(val * 1000));
			var Y = dateTime.getFullYear(), m = dateTime.getMonth() + 1, d = dateTime.getDate(), H = dateTime.getHours(), i = dateTime.getMinutes(), s = dateTime.getSeconds();
			var time = Math.round(new Date() / 1000);
			if(time - parseInt(val) < 60)  return time - parseInt(val)+'秒前';
			if(time - parseInt(val) > 60 && time - parseInt(val) < 3600) return new Date(parseInt((time - parseInt(val)) *1000)).getMinutes()+'分钟前';
			if(time - parseInt(val) > 3600 && time - parseInt(val) < 86400) return new Date(parseInt((time - parseInt(val)) *1000)).getHours()+'小时前';
			if (m < 10) m = '0' + m;
			if (d < 10) d = '0' + d;
			if (H < 10) H = '0' + H;
			if (i < 10) i = '0' + i;
			if (s < 10) s = '0' + s;
			return Y + '-' + m + '-' + d + ' ' + H + ':' + i + ':' + s;
		},
		// 创建邮箱列表
		create_mail_list: function (callback) {
			var _this = this,val = $('.domain_input').text(),username = '';
			this.get_domains_html(function(ress){
				if(ress != undefined){
					if(ress.data.length >0){
						username = ress.data[0].username;
					}else{
						return false;
					}
				}else{
					username = $('.domain_input').text();
					if(username == '暂无用户'){
						return false;
					}
				}
				_this.get_mail_list({username:username}, function (res) {
					var rdata = res.data, _tbody = '', time = '', subject = '';
					_this.mail_list = res.data;
					if(!(res.status == false && res.msg == '账号名不合法')){
					if(rdata.length >0){
						for (var i = 0; i < rdata.length; i++) {
							var _html = rdata[i].html.replace(/[^\u4e00-\u9fa5]/g,'');
							_html = _html.substr(0,100);
							if(_html == '') _html = rdata[i].body;
							_tbody += '<tr><td><span style="display: block;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;width:150px" title="' + _this.htmlEscape(rdata[i].from) + '">' + _this.htmlEscape(rdata[i].from) + '</span></td><td><a href="javascript:;" class="btlink mail_html"  onclick="mail.check_mail_view(' + i + ')">' + rdata[i].subject + '<span>&nbsp;-&nbsp;' + _html + '</span></a></td><td>' + _this.formatTime(new Date(rdata[i].time)) + '</td><td style=""><a href="javascript:;" class="btlink" onclick="mail.check_mail_view(' + i + ')">查看邮件</a></td></tr>'
						}
					}
					}
					$('#mails_list').html(_tbody);
					_this.table_auto_width('.mail_html',0.4);
				});
			});
		},

		htmlEscape: function (text) {
			return text.replace(/[<>"&]/g, function (match, pos, originalText) {
				switch (match) {
					case "<": return "&lt;";
					case ">": return "&gt;";
					case "&": return "&amp;";
					case "\"": return "&quot;";
				}
			});
		},
		// 查看邮件视图
		check_mail_view: function (index) {
			var item = this.mail_list[index], _this = this;
			layer.open({
				type: 1,
				title: '查看邮件【' + item.subject + '】',
				area: ['850px','800px'],
				maxmin:true,
				btn: ['回复邮件', '取消'],
				content: "<div class='bt-form'>\
					<div class='mail_title'>\
						<ul>\
							<li style='margin-bottom:5px;'><h4>"+ item.subject + "</h4></li>\
							<li>发件人："+ _this.htmlEscape(item.from) + "</li>\
							<li>时间："+ item.time + "</li>\
							<li>收件人："+ _this.htmlEscape(item.to) + "</li>\
						</ul>\
					</div>\
					<div class='mail_conter pd15'></div>\
				</div>",
				success: function (layers, index) {
					$('.mail_conter').html((item.html== ''?item.body:item.html));
				},
				yes: function (index, layers) {
					$('[name="mail_to"]').val(item.from.replace(/([<>])*/, ''));
					$('[name="subject"]').val('回复邮件[ ' + item.subject + ' ]');
					$('.tab-nav span:eq(2)').click()
					CKEDITOR.instances.editor1.setData('');
					layer.close(index);
				}
			})
		},
		// 获取邮箱用户列表
		get_mailboxs_list: function (obj, callback) {
			var _this  = this;
			if(!_this.is_update){
				if (callback) callback();
				return false;
			}
			this.send({
				tips: '正在获取用户列表,请稍后...',
				method: 'get_mailboxs',
				data: {
					domain: obj.domain || '',
					page: obj.page || 1,
					size: obj.size || 20
				},
				check: true,
				success: function (res) {
					if (callback) callback(res);
					_this.is_update = false;
				}
			});
		},
		// 添加邮箱用户
		add_mailboxs: function (obj, callback) {
			this.send({
				tips: '正在添加邮箱用户,请稍后...',
				method: 'add_mailbox',
				data: {
					quota: obj.quota,
					username: obj.username,
					password: obj.password,
					quote: obj.quote,
					full_name: obj.full_name,
					department: obj.department,
					position: obj.position,
					phone: obj.phone,
					sex: obj.sex,
					is_admin: obj.is_admin
				},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 删除邮箱用户列表
		del_mailboxs: function (obj, callback) {
			this.send({
				tips: '正在删除邮箱用户中，请稍后...',
				method: 'delete_mailbox',
				data: { username: obj.username },
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 编辑邮箱用户
		updatae_mailboxs: function (obj, callback) {
			this.send({
				tips: '正在编辑邮箱用户中,请稍后...',
				method: 'update_mailbox',
				data: {
					quota: obj.quota,
					username: obj.username,
					password: obj.password,
					quote: obj.quote,
					full_name: obj.full_name,
					department: obj.department,
					position: obj.position,
					phone: obj.phone,
					sex: obj.sex,
					active: obj.active,
					is_admin: obj.is_admin
				},
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},
		// 添加域名
		add_domain: function (obj, callback) {
			this.send({
				tips: '正在添加域名，请稍后...',
				method: 'add_domain',
				data: {
					domain: obj.domain,
					company_name: obj.company_name,
					admin_name: obj.admin_name,
					admin_phone: obj.admin_phone
				},
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},
		// 删除域名
		del_domain: function (obj, callback) {
			this.send({
				tips: '正在删除域名，请稍后...',
				method: 'delete_domain',
				data: {
					domain: obj.domain
				},
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},
		// 更新域名信息
		update_domain: function (obj, callback) {
			this.send({
				tips: '正在修改域名数据，请稍后...',
				method: 'update_domain',
				data: {
					active: obj.active,
					domain: obj.domain,
					company_name: obj.company_name,
					admin_name: obj.admin_name,
					admin_phone: obj.admin_phone
				},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 获取域名列表
		get_domain_list: function (obj, callback) {
			this.send({
				tips: '正在获取域名列表,请稍后....',
				method: 'get_domains',
				data: { page: obj.page, size: obj.size },
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 发送邮件内容
		send_mail_conter: function (obj, callback) {
			this.send({
				tips: '正在发送邮件中，请稍后...',
				method: 'send_mail',
				data: {
					smtp_server: obj.smtp_server || 'localhost',
					mail_from: obj.mail_from,
					password: obj.password,
					mail_to: obj.mail_to,
					subject: obj.subject,
					content: obj.content,
					subtype: obj.subtype || 'plain'
				},
				success: function (res) {
					if (callback) callback(res)
				}
			});
		},
		// 登录邮箱界面
		login_mail_stuats: function (obj, callback) {
			this.send({
				tips: '正在效验邮箱账号，请稍后...',
				method: 'login',
				data: {
					username: obj.username,
					password: obj.password,
					smtp_server: obj.smtp_server,
					protocol: obj.protocol,
					imap_server: obj.imap_server,
					pop_server: obj.pop_server
				},
				success: function (res) {
					if (callback) callback(res);
					bt.set_cookie('mail_login', JSON.stringify(res.data));
				}
			});
		},
		// 创建登录视图
		create_login_view: function () {
			var _this = this;
			var login = JSON.parse(bt.get_cookie('mail_login'));
			if (login == null) {
				login = {
					username: '',
					password: '',
					protocol: 'imap',
					smtp_server: 'localhost',
					imap_server: 'localhost',
					pop_server: 'localhost'
				}
			}
			login.protocol = login.protocol.toUpperCase();
			layer.open({
				type: 1,
				title: '邮箱登录',
				area: '400px',
				closeBtn: 2,
				btn: ['登录', '取消'],
				content: "<div class='bt-form bt-form-login pd20'>\
					<div class='line' style='display:none'>\
						<label><span></span><input type='text' class='bt-input-text mr5' name='userName' ></label>\
						<label><span></span><input type='password' class='bt-input-text mr5' name='hidden2' ></label>\
					</div>\
					<div class='line'>\
						<span class='tname'>邮箱账号</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='username' autocomplete='off' value='"+ login.username + "' placeholder='请输入邮箱账号' style='width:210px;' />\
						</div>\
					</div>\
					<div class='line'>\
						<span class='tname'>密码</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='password' name='password' autocomplete='new-password' value='"+ login.password + "' placeholder='请输入邮箱密码' style='width:210px;' />\
							<span class='glyphicon glyphicon-eye-open cursor cut-eye-open' style='margin-left:-30px'></span>\
						</div>\
					</div>\
					<div class='line'>\
						<span class='tname'>收件协议</span>\
						<div class='info-r c4'>\
							<select class='bt-input-text mr5' name='protocol' style='width:100px'>\
								<option "+ (login.protocol == 'IMAP' ? 'selected' : '') + " value='imap'>IMAP</option>\
								<option "+ (login.protocol == 'POP' ? 'selected' : '') + " value='pop'>POP</option>\
							</select>\
						</div>\
					</div>\
					<div class='line smtp_view' style='display:"+ (login.protocol == 'SMTP' ? 'block' : 'none') + "'>\
						<span class='tname'>SMTP服务地址</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='smtp_server' value='"+ login.smtp_server + "' placeholder='请输入管理员手机' style='width:210px;' />\
						</div>\
					</div>\
					<div class='line imap_view' style='display:"+ (login.protocol == 'IMAP' ? 'block' : 'none') + "'>\
						<span class='tname'>IMAP服务地址</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='imap_server' value='"+ login.imap_server + "' placeholder='请输入管理员手机' style='width:210px;' />\
						</div>\
					</div>\
					<div class='line pop_view' style='display:"+ (login.protocol == 'POP' ? 'block' : 'none') + "'>\
						<span class='tname'>POP服务地址</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='pop_server' value='"+ login.pop_server + "' placeholder='请输入管理员手机' style='width:210px;' />\
						</div>\
					</div>\
				</div>",
				success: function () {
					$("[name='protocol']").change(function () {
						switch ($(this).val()) {
							case 'smtp':
								$('.smtp_view').show();
								$('.imap_view,.pop_view').hide();
							break;
							case 'imap':
								$('.imap_view').show();
								$('.smtp_view,.pop_view').hide();
							break;
							case 'pop':
								$('.pop_view').show();
								$('.imap_view,.smtp_view').hide();
							break;
						}
					});
					$(".cut-eye-open").click(function () {
						if ($(this).hasClass('glyphicon-eye-open')) {
							$(this).prev().attr('type', 'text');
							$(this).removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');
						} else {
							$(this).prev().attr('type', 'password');
							$(this).removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');
						}
					})
				},
				yes: function (index, layers) {
					var arry = [['username', '用户邮箱不能为空！'], ['password', '密码不能为空']];
					var username = $('[name="username"]').val(), password = $('[name="password"]').val(), _form = {};
					if (username == '') {
						layer.msg('用户邮箱账号不能为空！', { icon: 2 });
						return false;
					} else if (password == '') {
						layer.msg('用户邮箱密码不能为空！', { icon: 2 });
						return false;
					}
					_form['username'] = $('[name="username"]').val();
					_form['password'] = $('[name="password"]').val();
					_form['protocol'] = $('[name="protocol"]').val();
					_form[_form['protocol'] + '_server'] = $('[name="' + _form['protocol'] + '_server' + '"]').val();
					_this.login_mail_stuats(_form, function (res) {
						$('.service_tip a').html(res.data.username + '&nbsp;&nbsp;[ 切换账号 ]');
						layer.close(index);
						layer.msg(res.msg, { icon: 1 });
					});
				}
			})
		},
		// 请求
		send: function (obj) {
			var loadT = '';
			if (obj.load == undefined) obj.load = 0;
			if (obj.url == undefined) {
				if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this
					.plugin_name
				if (!obj.plugin_name || !obj.method) {
					layer.msg('插件类名称，或插件方法名称缺失!', {
						icon: 2
					});
					return false;
				}
			}
			if (obj.load === 0 || obj.tips != '') {
				loadT = layer.msg(obj.tips, {
					icon: 16,
					time: 0,
					shade: 0.3
				});
			} else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
				loadT = layer.load();
			}
			$.ajax({
				type: 'POST',
				url: obj.url != undefined ? obj.url : ('/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method),
				data: obj.data || {},
				timeout: obj.timeout || 99999999,
				complete: function (res) {
					if (obj.load === 0 || obj.load === 1) layer.close(loadT);
				},
				success: function (rdata) {
					if (obj.check) {
						obj.success(rdata);
						return false
					}
					if (rdata.status === false) {
						layer.msg(rdata.msg, { icon: 2 });
						return false;
					}
					obj.success(rdata);
				},
				error: function (ex) {
					if (!obj.error) {
						obj.msg || obj.msg == undefined ? layer.msg('请求过程发现错误!', {
							icon: 2
						}) : '';
						return;
					}
					return obj.error(ex);
				}
			});
		}
	}
	mail.init();
</script>