<!DOCTYPE html>
<html>
<head>
    <style>
        .fileUploadDiv {
            padding: 10px
        }

        #file_input {
            display: none
        }

        #up_box {
            background-color: #fafbfe;
            border: #e4e5e9 1px solid;
            margin: 0;
            padding: 10px;
            clear: both;
            height: 335px;
            overflow: auto
        }

            #up_box li {
                list-style-type: none;
                height: 30px;
                line-height: 30px;
                font-size: 12px;
                width: 100%;
                margin: 0 0 5px;
                padding: 0
            }

                #up_box li .filename {
                    display: inline-block;
                    height: 30px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    width: 240px
                }

                #up_box li .filesize {
                    color: #999;
                    display: inline-block;
                    height: 30px;
                    overflow: hidden
                }

        .fileUploadDiv button {
            float: left;
            border-radius: 3px;
            border-style: solid;
            border-width: 1px;
            width: 75px;
            height: 30px;
            color: #fff;
            margin-bottom: 10px;
            cursor: pointer
        }

        #up {
            background-color: #5cb85c;
            border-color: #4cae4c;
            color: #fff;
            text-align: center;
            margin-left: 10px;
            position: absolute;
            bottom: 0;
            right: 10px
        }

        #filesClose {
            position: absolute;
            bottom: 0;
            right: 95px;
            background-color: #cbcbcb;
            border-color: #cbcbcb;
            color: #fff
        }

        #opt {
            background-color: #4592f0;
            border-color: #367fa9
        }

        #up_box li em {
            font-style: normal;
            color: #06F;
            float: right;
            margin-right: 10px
        }
        #totalProgress progress {
            width: 180px;
            height: 10px;
            border: 1px solid #ccc;
            background-color: #e6e6e6;
            color: #0064b4;
            opacity: .9
        }

        #totalProgress p {
            color: #666
        }

    </style>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="static/layui/css/layui.css" media="all">
    <script type="text/javascript" src="/static/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="static/layui/layui.js"></script>
</head>

<body>
    <button onclick="upload_file.open('/www/test')">上传</button>
    <script>
        var layer;
        layui.use('layer', function () {
            layer = layui.layer;
        });
        
        var upload_file = {
            f: null,
            f_total: 0,
            f_path:null,
            split_size: 1024 * 1024 * 2,
            _files: [],
            _error: 0,
            _start_time:0,
            
            open: function (path) {
                upload_file.f_path = path;

                //是否支持上传目录
                user_agent = navigator.userAgent.toLowerCase()
                var btn_dir = '';
                if (user_agent.indexOf('chrome') != -1 || user_agent.indexOf('firefox') != -1) {
                    btn_dir = '<input type="file" id="dir_input" onchange="upload_file.list(this.files)" style="display:none;"  multiple="true" autocomplete="off" multiple webkitdirectory /><button type="button" style="margin-left: 10px;"  id="opt" onclick="$(\'#dir_input\').click()" autocomplete="off">选择目录</button>';
                }

                layer.open({
                    type: 1,
                    title: '上传文件到['+path+']',
                    area: ['500px', '500px'],
                    shadeClose: false,
                    closeBtn:false,
                    content: '<div class="fileUploadDiv"><input type="hidden" id="input-val" value="' + path + '" />\
				                <input type="file" id="file_input" onchange="upload_file.list(this.files)"  multiple="true" autocomplete="off" />\
				                <button type="button"  id="opt" onclick="$(\'#file_input\').click()" autocomplete="off">选择文件</button>\
                                '+ btn_dir+'\
                                <span id="totalProgress" style="position: absolute;top: 7px;right: 10px;"></span>\
                                <span>\
				                <button type="button" id="up" autocomplete="off" onclick="upload_file.start(0)">开始上传</button>\
				                <button type="button" id="filesClose" autocomplete="off" onClick="layer.closeAll()" >关闭</button>\
                                </span>\
				                <ul id="up_box"></ul></div>'
                 });
            },
            list: function (_files) {
                upload_file._files = _files;
                var up_box = $("#up_box");
                $("#up_box").html('');
                for (var i = 0; i < _files.length; i++) {
                    var f_name = _files[i].name
                    if (_files[i].webkitRelativePath) f_name = _files[i].webkitRelativePath;
                    up_box.append('<li class="offset-'+i+'"><span class="filename">' + f_name + '</span><span class="filesize">' + upload_file.to_size(_files[i].size) + '</span><em>等待上传</em></li>')
                }
            },
            to_size: function (a) {
                var d = [" B", " KB", " MB", " GB", " TB", " PB"];
                var e = 1024;
                for (var b = 0; b < d.length; b++) {
                    if (a < e) {
                        return (b == 0 ? a : a.toFixed(2)) + d[b]
                    }
                    a /= e
                }
            },

            start: function (i) {
                var len = upload_file._files.length
                if (len == 0) {
                    layer.msg('请选择文件!', { icon: 2 });
                    return false;
                }
                $("#filesClose,#up,#opt").attr("disabled", "disabled");

                $("#totalProgress").html('<p>已上传(' + i + '/' + len + ')</p> <progress value="'+i+'" max="' + len+'"></progress>');
                if (len <= i) {
                    $("#totalProgress").html('<p>上传完成(' + i + '/' + len + ')</p> <progress value="' + i + '" max="' + len + '"></progress>');
                    upload_file._files = [];
                    $("#filesClose,#up,#opt").removeAttr("disabled");
                    return false;
                }
                if (i > 10) {
                    $("#up_box").scrollTop((35 * (i-10)) + 50)
                }
                upload_file._error = 0;
                upload_file.f = upload_file._files[i]
                upload_file.f_total = Math.ceil(upload_file.f.size / upload_file.split_size);
                upload_file.upload(0,i)
            },

            upload: function (start,i) {
                //计算分片结束位置
                var end = Math.min(upload_file.f.size, start + upload_file.split_size);

                //文件名处理
                var f_path = upload_file.f_path
                if (upload_file.f.webkitRelativePath) {
                    f_path = upload_file.f_path + '/' + upload_file.f.webkitRelativePath.replace('/' + upload_file.f.name,'');
                }
                //准备表单数据
                var form = new FormData();
                form.append("f_path", f_path.replace('//','/'));
                form.append("f_name", upload_file.f.name);
                form.append("f_size", upload_file.f.size);
                form.append("f_start", start);
                form.append("blob", upload_file.f.slice(start, end));
                form.append("m", "coll_upload");
                form.append("f", "upload");

                $.ajax({
                    url: "/coll/ajax.json",
                    type: "POST",
                    data: form,
                    async: true,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (typeof (data) == "number") {
                            var progress = parseInt(data / upload_file.f.size * 100);
                            $("#up_box li em")[i].outerHTML = '<em style="color:green;">上传进度:' + progress + '%</em>'
                            $("#up_box li .filesize")[i].outerHTML = '<span class="filesize">' + upload_file.to_size(data)+'/' + upload_file.to_size(upload_file.f.size)+'</span>'
                            $("#up_box li em")[i].focus();
                            upload_file.upload(data,i);
                        } else {
                            if (data.status) {
                                $("#up_box li em")[i].outerHTML = '<em style="color:green;">已上传成功</em>'
                                $("#up_box li .filesize")[i].outerHTML = '<span class="filesize">' + upload_file.to_size(upload_file.f.size) + '/' + upload_file.to_size(upload_file.f.size) + '</span>'
                            } else {
                                $("#up_box li em")[i].outerHTML = '<em style="color:red;">' + data.msg + '</em>'
                            }
                            upload_file.start(i + 1)
                        }
                    },
                    error: function (e) {
                        if (upload_file._error > 5) {
                            $("#up_box li em")[i].outerHTML = '<em style="color:red;">上传失败</em>'
                            upload_file.start(i + 1)
                            return;
                        }
                        upload_file._error++;
                        upload_file.upload(start, i);
                    }
                });
            }
        }
    </script>
</body>
</html>